# Пример реализации микросервисного приложения

### Общая схема архитектурного решения:

![img.png](img.png)

Приложение состоит из сервисов Order, Billing и Notification,
а также Spring Cloud Gateway API для роутинга запросов на эти сервисы.
Межсервисное взаимодействие осуществляется через брокер сообщений (kafka).
Пользователь взаимодействует с сервисами через вызов REST-сервисов

## Описание сценариев использования:

- Создать пользователя (аккаунт в биллинге).
- Положить деньги на счет пользователя в сервисе биллинга.
- Сделать заказ, на который хватает денег в сервисе заказов.
- Посмотреть деньги на счету пользователя в сервисе биллинга и убедиться, что их сняли.
- Посмотреть в сервисе нотификаций отправленные сообщения и убедиться, что сообщение отправилось
- Сделать заказ, на который не хватает денег в сервисе заказов.
- Посмотреть деньги на счету пользователя и убедиться, что их количество не поменялось.
- Посмотреть в сервисе нотификаций отправленные сообщения и убедиться, что сообщение отправилось.

## Технические подробности реализации

### Установка в k8s через helm:

- Перейти в корневую директорию проекта
- Выполнить `helm install orbilnot ./helm`

### приложение состоит из следующих модулей:

#### billing - Сервис биллинга

Ключевые особенности: Rest Controller, Kafka Consumer, Kafka Producer, Scheduler

- Здесь пользователь может создать новый аккаунт и положить/снять деньги с этого аккаунта через REST
  Controller `AccountController`
- `OrderEventsListener` слушает события заказов из топика `order.event` сообщений и сохраняет их в БД со
  статусом `RECEIVED`
    - Событие состоит из номера счёта, номера заказа, и суммы заказа
- `ReceivedOrderEventsProcessingScheduler` обрабатывает все пришедшие события со статусом `RECEIVED`
    - Если денег на счёте достаточно для оплаты заказа:
        - Деньги списываются со счёта
        - Событие переходит в статус `PAYMENT_CONFIRMED`
    - Если денег на счёте не хватает:
        - Событие переходит в статус `PAYMENT_DENIED`
- `SendPaymentProcessingResultsScheduler`:
    - отправляет сообщения об успешных и неуспешных оплатах в
      топик `payment.event`
    - Переводит событие в терминальный статус `EXECUTED`

#### order - Сервис заказов

Ключевые особенности: Rest Controller, Kafka Consumer, Kafka Producer, Scheduler

- Здесь пользователь может создать/изменить/удалить заказ и посмотреть список своих заказов через REST
  Controller `OrdersController`
- Новый заказ создаётся со статусом `NEW` и содержит параметры: номер счёта, номер заказа, сумма заказа
- `SendOrderEventMessagesToTopicScheduler`:
    - берёт все заказы в статусе `NEW`
    - для каждого из заказов производится отправка события заказа в топик `order.event`
    - Переводит заказ в статус `SENT`
- `PaymentEventListener` слушает события об успешных и неуспешных оплатах из топика `payment.event`:
    - Если получено сообщение об успешной оплате, заказ переходит в статус `CONFIRMED`
    - Если получено сообщение о НЕуспешной оплате, заказ переходит в статус `CANCELLED`

#### notification - Сервис уведомлений

Ключевые особенности: Rest Controller, Kafka Consumer
осуществляет рассылку уведомлений пользователям
(в текущей реализации происходит сохранение уведомлений в БД)

- Пользователь может посмотреть список всех своих уведомлений через REST Controller `NotificationsController`
- `PaymentEventListener` слушает события об успешных и неуспешных оплатах из топика `payment.event`:
    - Если пришло сообщение об успешной оплате, создаётся уведомление об успешной оплате
    - Если пришло сообщение об неуспешной оплате, создаётся уведомление о неуспешной оплате

#### gateway - Маршрутизатор запросов

Ключевые особенности: Spring Cloud Gateway Api

осуществляет роутинг запросов

- Запросы, содержащие путь `/account` роутятся в сервис биллинга
- Запросы, содержащие путь `/notifications` роутятся в сервис нотификаций
- Запросы, содержащие путь `/order` роутятся в сервис заказов

#### model

Общие классы, используемые в других модулях, в частности DTO для обмена сообщениями

#### migration
Содержит скрипты инициализации БД и последующей миграции данных
- Скрипты содержатся в папке `sql/scripts`


### Брокер сообщений, БД, Миграция

- Для обмена сообщениями между сервисами используется Кафка
- В качестве БД используется postgresql
- Кафка и Postgres устанавливаются вместе с основными сервисами и не требуют дополнительной настройки
- Миграция данных осуществляется с помощью k8s job: orbilnot-migration-job
    - Джоба вызывает liquibase.maven.plugin
    - Поды `billing`, `order`, `notification` ждут, когда джоба завершится и только после этого поднимают свои основные
      контейнеры